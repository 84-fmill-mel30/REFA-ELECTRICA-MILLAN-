<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill√°n - V18 FINAL</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ffd700; --dark: #111; --bg: #f4f4f4; --success: #00c851; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); color: #333; padding-bottom: 80px; }
        
        /* HEADER */
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.2rem; font-weight: 900; }
        .logo span { color: var(--primary); }
        .status-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; margin-left: 5px; }

        /* NAVEGACI√ìN */
        nav button { background: none; border: none; color: #888; font-size: 1.5rem; margin-left: 15px; cursor: pointer; }
        nav button.active { color: var(--primary); transform: scale(1.2); }

        /* P√ÅGINAS */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* BUSCADOR */
        .search-container { background: white; padding: 10px; position: sticky; top: 60px; z-index: 900; border-bottom: 2px solid #ddd; }
        .main-input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #ccc; font-size: 1.2rem; outline: none; box-sizing: border-box; }
        
        /* LISTA */
        .card { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; border-bottom: 3px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .card-info { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 1rem; color: #333; }
        .card-code { font-size: 0.8rem; color: #666; background: #eee; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .card-price { font-size: 1.4rem; font-weight: 900; color: var(--success); text-align: right; min-width: 90px; }
        .btn-add { background: var(--dark); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: pointer; width: 100%; }

        /* ADMIN */
        table { width: 100%; background: white; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #333; color: white; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 5px; border-radius: 4px; }

        /* EL COMPITA */
        #compita-btn { position: fixed; bottom: 20px; right: 20px; width: 70px; height: 70px; background: #222; border: 2px solid var(--primary); border-radius: 50%; color: var(--primary); font-size: 2rem; z-index: 9999; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #compita-btn.listening { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* MODALES */
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:5000; display:none; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<header>
    <div class="logo">MILL√ÅN <span>V18</span> <div id="status" class="status-dot"></div></div>
    <nav>
        <button onclick="nav('home')" id="btn-home" class="active"><i class="fas fa-list"></i></button>
        <button onclick="nav('pos')" id="btn-pos"><i class="fas fa-shopping-cart"></i></button>
        <button onclick="openAdmin()" id="btn-admin"><i class="fas fa-lock"></i></button>
    </nav>
</header>

<div id="compita-btn" onclick="startVoice()"><i class="fas fa-microphone"></i></div>

<div id="home" class="page active">
    <div class="search-container">
        <input type="text" id="search" class="main-input" placeholder="üîç Buscar pieza..." onkeyup="filterList()">
    </div>
    
    <button onclick="openGoogle()" style="width:100%; padding:15px; background:white; border:2px solid #4285F4; color:#4285F4; border-radius:10px; margin-top:10px; font-weight:bold; font-size:1rem;">
        <i class="fab fa-google"></i> BUSCAR EN GOOGLE
    </button>

    <div id="list-area" style="padding-bottom: 50px;"></div>
</div>

<div id="pos" class="page">
    <h2>Caja</h2>
    <button onclick="startCam()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px;">üì∏ C√ÅMARA</button>
    <div id="reader" style="width:100%; display:none;"></div>
    
    <div id="cart-display" style="background:white; min-height:100px; padding:10px; margin-top:20px; border:1px solid #ccc;">
        <div style="text-align:center; color:#999;">Carrito Vac√≠o</div>
    </div>
    <h1 style="text-align:right;">Total: $<span id="total-val">0</span></h1>
    <button onclick="printTicket()" style="width:100%; padding:15px; background:var(--success); color:white; border:none; border-radius:5px; font-size:1.2rem; font-weight:bold;">COBRAR</button>
</div>

<div id="admin" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>ADMINISTRACI√ìN</h2>
        <button onclick="nav('home')" style="color:red; background:none; border:none; font-weight:bold;">SALIR</button>
    </div>

    <div style="background:white; padding:10px; border-radius:5px;">
        <label>Ganancia (%):</label>
        <input type="number" id="margin-val" value="30" style="width:60px; padding:5px;">
        <button onclick="applyMargin()" style="background:#33b5e5; color:white; border:none; padding:5px 10px; border-radius:5px;">APLICAR</button>
    </div>

    <h3>Inventario Completo</h3>
    <input type="text" id="admin-search" placeholder="Filtrar..." onkeyup="renderAdmin()" style="width:100%; padding:10px; box-sizing:border-box;">
    
    <div style="overflow-x:auto;">
        <table id="admin-table">
            <thead><tr><th>Cod</th><th>Desc</th><th>$$</th><th>X</th></tr></thead>
            <tbody id="admin-tbody"></tbody>
        </table>
    </div>

    <br><br>
    <button onclick="factoryReset()" style="background:red; color:white; padding:15px; width:100%; border:none; border-radius:5px;">‚ö†Ô∏è RECARGAR LISTA ORIGINAL</button>
</div>

<div id="login-overlay">
    <h2>CLAVE</h2>
    <input type="password" id="pin" style="font-size:2rem; width:150px; text-align:center;" placeholder="****">
    <br><br>
    <button onclick="checkPin()" style="padding:10px 30px; background:var(--primary); border:none; font-weight:bold;">ENTRAR</button>
    <button onclick="closeLogin()" style="background:none; border:none; margin-top:20px; text-decoration:underline;">Cancelar</button>
</div>

<script>
    // --- DATOS REALES ---
    const DB_RAW = [
        {c:"E7691809", n:"Engrane Marcha Dodge (2)", cost:30}, {c:"E7691810", n:"Engrane Marcha Ford Bosch (1)", cost:30},
        {c:"EM4", n:"Engrane Marcha Nissan (4)", cost:29}, {c:"EM5", n:"Engrane Marcha VW Golf (5)", cost:29},
        {c:"1224", n:"Bendix Zen Ford", cost:114}, {c:"A618114ASS", n:"Armadura Nissan Hitachi", cost:264},
        {c:"A011097E", n:"Armadura Nissan Chevy", cost:264}, {c:"PC10530941", n:"Porta Carbon GM Aveo", cost:75},
        {c:"PC336246", n:"Porta Carbon Ford Nissan", cost:69}, {c:"PC336245", n:"Porta Carbon Nissan Chevy", cost:69},
        {c:"B55", n:"Modulo Encendido Tsuru 16V", cost:543}, {c:"BOM-TSURU", n:"Bomba Gasolina Tsuru III", cost:330},
        {c:"RIH738TP", n:"Regulador Nissan Hitachi", cost:317}, {c:"F9004LED", n:"Foco 9004 LED 4 Caras", cost:275},
        {c:"67HELLA", n:"Foco 67 Hella (Suelto)", cost:3.30}, {c:"158HELLA", n:"Foco 158 Pellizco (Suelto)", cost:2.40},
        {c:"1034HELLA", n:"Foco 1034 (Suelto)", cost:3.50}, {c:"BM70582", n:"Bulbo Motovent VW Caribe", cost:98},
        {c:"CP1830M", n:"Cable Plastico 18 30mts", cost:88}, {c:"952011", n:"Bocina Claxon VW Hella", cost:121},
        {c:"PC698309", n:"Porta Carbon Mitsubishi Grande", cost:75}, {c:"PC698308", n:"Porta Carbon Mitsubishi Chico", cost:58},
        {c:"PC36441", n:"Porta Carbon Platina Valeo", cost:69}, {c:"PC336716", n:"Porta Carbon Bosch Automotive", cost:72},
        {c:"PC336200", n:"Porta Carbon VW Jetta Eco", cost:69}, {c:"PC698104", n:"Porta Carbon Nissan Hueco", cost:81},
        {c:"SLDSS1750", n:"Automatico Ford Bosch", cost:220}, {c:"1219", n:"Automatico Nissan Hitachi", cost:215}
    ];

    // Variables
    let INVENTARIO = [];
    let CART = [];
    let MARGEN = 30;
    let scanner = null;

    // --- ARRANQUE SEGURO ---
    window.onload = function() {
        try {
            // Cargar o Inicializar
            let stored = localStorage.getItem('millan_v18_db');
            if(stored) {
                INVENTARIO = JSON.parse(stored);
            } else {
                // Carga inicial
                INVENTARIO = JSON.parse(JSON.stringify(DB_RAW));
                INVENTARIO.forEach(p => p.price = Math.ceil(p.cost * 1.30));
                save();
            }
            
            // Pintar interfaz
            renderList();
            
            // Indicador de √©xito (Verde)
            document.getElementById('status').style.background = "#00c851";
            
        } catch (e) {
            alert("Error al iniciar. Reseteando...");
            factoryReset();
        }
    };

    // --- FUNCIONES PRINCIPALES ---

    function save() {
        localStorage.setItem('millan_v18_db', JSON.stringify(INVENTARIO));
    }

    function renderList() {
        let q = document.getElementById('search').value.toUpperCase();
        let div = document.getElementById('list-area');
        div.innerHTML = "";

        let list = INVENTARIO.filter(p => p.n.toUpperCase().includes(q) || p.c.toUpperCase().includes(q));

        if(list.length === 0) {
            div.innerHTML = "<p style='text-align:center; padding:20px;'>No encontrado.</p>";
            return;
        }

        list.forEach(p => {
            div.innerHTML += `
            <div class="card">
                <div class="card-info">
                    <div class="card-title">${p.n}</div>
                    <div class="card-code">${p.c}</div>
                </div>
                <div>
                    <div class="card-price">$${p.price}</div>
                    <button class="btn-add" onclick="addCart('${p.c}')">AGREGAR</button>
                </div>
            </div>`;
        });
    }

    function filterList() {
        renderList();
    }

    function openGoogle() {
        let txt = document.getElementById('search').value;
        if(!txt) txt = "Refaccion Automotriz";
        window.open("https://www.google.com/search?tbm=isch&q=" + txt, "_blank");
    }

    // --- CAJA ---
    function addCart(c) {
        let p = INVENTARIO.find(x => x.c === c);
        if(p) {
            CART.push(p);
            alert("Agregado: " + p.n);
        }
    }

    function renderCart() {
        let div = document.getElementById('cart-display');
        let tot = 0; 
        div.innerHTML = "";
        
        if(CART.length === 0) {
            div.innerHTML = "<div style='text-align:center; color:#999;'>Carrito Vac√≠o</div>";
        } else {
            CART.forEach((p, i) => {
                tot += p.price;
                div.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;">
                    <span>${p.n}</span>
                    <span>$${p.price} <b style="color:red; margin-left:10px;" onclick="delCart(${i})">X</b></span>
                </div>`;
            });
        }
        document.getElementById('total-val').innerText = tot;
    }

    function delCart(i) { CART.splice(i,1); renderCart(); }
    
    function printTicket() {
        if(CART.length > 0) {
            window.print();
            if(confirm("¬øCobro realizado?")) { CART=[]; renderCart(); }
        } else {
            alert("Nada que cobrar");
        }
    }

    // --- ADMIN ---
    function openAdmin() {
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('pin').value = "";
    }

    function checkPin() {
        if(document.getElementById('pin').value === "1234") {
            closeLogin();
            nav('admin');
            renderAdminTable();
        } else {
            alert("Clave incorrecta");
        }
    }

    function closeLogin() { document.getElementById('login-overlay').style.display = 'none'; }

    function renderAdminTable() {
        let tbody = document.getElementById('admin-tbody');
        let filter = document.getElementById('admin-search').value.toUpperCase();
        tbody.innerHTML = "";

        INVENTARIO.forEach(p => {
            if(p.n.toUpperCase().includes(filter) || p.c.includes(filter)) {
                tbody.innerHTML += `<tr>
                    <td>${p.c}</td>
                    <td>${p.n}</td>
                    <td>$${p.price}</td>
                    <td><button onclick="delProd('${p.c}')" class="btn-danger">X</button></td>
                </tr>`;
            }
        });
    }
    
    function renderAdmin() { renderAdminTable(); } // Alias

    function delProd(c) {
        if(confirm("¬øBorrar?")) {
            INVENTARIO = INVENTARIO.filter(p => p.c !== c);
            save();
            renderAdminTable();
            renderList(); // Actualizar home tambi√©n
        }
    }

    function applyMargin() {
        let m = parseFloat(document.getElementById('margin-val').value);
        let f = 1 + (m/100);
        INVENTARIO.forEach(p => { if(p.cost) p.price = Math.ceil(p.cost * f); });
        save();
        renderAdminTable();
        renderList();
        alert("Precios actualizados");
    }

    function factoryReset() {
        if(confirm("¬øBORRAR TODO? Se perder√°n cambios.")) {
            localStorage.removeItem('millan_v18_db');
            location.reload();
        }
    }

    // --- UTILS ---
    function nav(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-'+id).classList.add('active');
        
        if(id === 'pos') renderCart();
        
        // Apagar cosas extras
        if(id !== 'pos') {
            document.getElementById('reader').style.display = 'none';
            if(scanner) scanner.clear();
        }
    }

    // --- COMPITA Y CAMARA (SAFE MODE) ---
    function startVoice() {
        if(!window.webkitSpeechRecognition) return alert("Tu cel no soporta voz. Usa Chrome.");
        
        let btn = document.getElementById('compita-btn');
        btn.classList.add('listening');
        
        try {
            let r = new webkitSpeechRecognition();
            r.lang = "es-MX";
            r.onend = () => btn.classList.remove('listening');
            r.onresult = (e) => {
                let txt = e.results[0][0].transcript.toLowerCase();
                let term = txt.replace("busca","").replace("precio","").trim();
                document.getElementById('search').value = term;
                nav('home');
                filterList();
                
                let found = INVENTARIO.find(p => p.n.toLowerCase().includes(term));
                if(found) speak("Sim√≥n, cuesta " + found.price);
                else speak("No lo topo");
            };
            r.start();
        } catch(e) {
            alert("Error de micr√≥fono");
            btn.classList.remove('listening');
        }
    }

    function speak(t) {
        if(window.speechSynthesis) {
            let u = new SpeechSynthesisUtterance(t);
            u.lang = "es-MX";
            window.speechSynthesis.speak(u);
        }
    }

    function startCam() {
        if(typeof Html5QrcodeScanner === 'undefined') return alert("Sin internet para c√°mara");
        
        let d = document.getElementById('reader');
        if(d.style.display === 'block') {
            d.style.display = 'none';
            if(scanner) scanner.clear();
        } else {
            d.style.display = 'block';
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render((t) => {
                addCart(t);
                scanner.pause();
                setTimeout(()=>scanner.resume(), 1500);
            });
        }
    }

</script>
</body>
</html>
