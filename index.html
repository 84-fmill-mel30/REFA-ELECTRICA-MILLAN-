<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill치n - V5.1 ESC츼NER</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ffd700; --dark: #111; --light: #eee; --danger: #ff4444; --success: #00cc66; --info: #00d2ff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #eef2f5; color: #333; padding-bottom: 80px; }
        
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .logo { font-size: 1.1rem; font-weight: 900; text-transform: uppercase; color: #fff; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary); font-size: 1.5rem; }
        nav button { background: none; border: none; color: #aaa; font-size: 1.5rem; margin-left: 20px; cursor: pointer; transition: 0.3s; }
        nav button.active { color: var(--primary); transform: scale(1.2); }

        .page { display: none; padding: 15px; max-width: 1000px; margin: 0 auto; }
        .page.active { display: block; }

        /* CATALOGO */
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; display: flex; flex-direction: column; }
        .prod-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .prod-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #333; min-height: 40px; }
        .prod-code { font-size: 0.7rem; color: #666; font-family: monospace; background: #eee; padding: 2px 5px; border-radius: 4px; width: fit-content; margin-bottom: 5px; }
        .prod-price { font-size: 1.2rem; font-weight: 900; color: var(--success); text-align: right; margin: 5px 0; }
        .btn-add { background: var(--dark); color: white; border: none; padding: 8px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 5px; font-size: 0.8rem; }
        
        .search-bar { position: sticky; top: 70px; z-index: 900; background: rgba(238, 242, 245, 0.95); padding: 10px 0; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ESC츼NER Y TICKET */
        .scanner-box { background: #000; border-radius: 10px; padding: 10px; margin-bottom: 20px; text-align: center; display: none; }
        #reader { width: 100%; }
        
        .cart-total { font-size: 1.5rem; font-weight: bold; text-align: right; margin: 20px 0; color: var(--dark); border-top: 2px solid #333; padding-top: 10px; }
        .ticket-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #ccc; background: white; }

        @media print {
            body * { visibility: hidden; }
            #ticket-print-area, #ticket-print-area * { visibility: visible; }
            #ticket-print-area { position: absolute; left: 0; top: 0; width: 100%; }
            header, nav, .btn-main { display: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="fas fa-bolt"></i> MILL츼N <span>V5.1</span></div>
    <nav>
        <button onclick="irA('catalog')" id="nav-catalog" class="active"><i class="fas fa-search"></i></button>
        <button onclick="irA('pos')" id="nav-pos"><i class="fas fa-barcode"></i></button>
        <button onclick="irA('admin')" id="nav-admin"><i class="fas fa-cog"></i></button>
    </nav>
</header>

<div id="catalog" class="page active">
    <div class="search-bar">
        <input type="text" id="catalog-search" placeholder="游댌 Buscar pieza, c칩digo o auto..." onkeyup="renderCatalog()">
    </div>
    <div id="catalog-container" class="catalog-grid"></div>
</div>

<div id="pos" class="page">
    <h2><i class="fas fa-cash-register"></i> Caja / Esc치ner</h2>
    
    <button id="btn-cam" onclick="toggleScanner()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px;">
        游닞 ACTIVAR C츼MARA
    </button>
    
    <div id="scanner-area" class="scanner-box">
        <div id="reader"></div>
        <button onclick="toggleScanner()" style="background:red; color:white; border:none; padding:5px 10px; margin-top:5px; border-radius:5px;">CERRAR C츼MARA</button>
    </div>

    <div id="cart-list" style="background:white; border-radius:5px; min-height:100px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <div style="text-align:center; color:#999; padding:20px;">Carrito Vac칤o</div>
    </div>
    
    <div class="cart-total">Total: $<span id="total-amount">0.00</span></div>
    <button onclick="imprimirTicket()" style="background:var(--success); color:white; width:100%; padding:15px; border:none; font-weight:bold; border-radius:8px; font-size:1.1rem;">COBRAR</button>
</div>

<div id="admin" class="page">
    <h2>Configuraci칩n</h2>
    <div style="background:#222; color:white; padding:15px; border-radius:10px;">
        <label>Ganancia Global (%):</label>
        <input type="number" id="global-margin" value="30" style="background:#444; color:#white; border:none; margin-top:5px; width:100%; padding:10px;">
        <button onclick="actualizarPrecios()" style="background:var(--info); width:100%; padding:10px; border:none; margin-top:10px; font-weight:bold; cursor:pointer;">ACTUALIZAR PRECIOS</button>
    </div>
    <br>
    
    <h3>Agregar Producto Manual</h3>
    <input type="text" id="new-code" placeholder="C칩digo Barras">
    <input type="text" id="new-name" placeholder="Nombre">
    <input type="number" id="new-cost" placeholder="Costo Compra ($)">
    <button onclick="guardarManual()" style="width:100%; padding:10px; background:var(--primary); border:none; font-weight:bold;">GUARDAR</button>
    
    <br><br>
    <button onclick="forceReset()" style="background:var(--danger); color:white; width:100%; padding:15px; border:none; border-radius:8px;">丘멆잺 RESTAURAR BASE DE DATOS ORIGINAL</button>
</div>

<div id="ticket-print-area" style="display:none; width:300px; font-family:monospace; padding:10px;">
    <div style="text-align:center;">
        <h3>REFACCIONARIA MILL츼N</h3>
        <p>Servicio a Domicilio</p>
        <div style="text-align:left;" id="ticket-date"></div>
    </div>
    <div id="ticket-body" style="margin-top:10px; font-size:0.9rem;"></div>
    <p>---------------------------</p>
    <div style="text-align:right; font-size:1.2rem; font-weight:bold;">TOTAL: $<span id="ticket-total">0.00</span></div>
</div>

<script>
    // --- DATOS REALES (DE TUS FOTOS) ---
    const DB_MASTER = [
        {c:"E7691809", n:"Engrane Marcha Dodge (2)", cost:30},
        {c:"E7691810", n:"Engrane Marcha Ford Bosch (1)", cost:30},
        {c:"EM4", n:"Engrane Marcha Nissan (4) y Chevy", cost:29},
        {c:"EM5", n:"Engrane Marcha VW Golf Jetta (5)", cost:29},
        {c:"A618114ASS", n:"Armadura Nissan Hitachi PMGR 114", cost:264},
        {c:"A011097E", n:"Armadura Nissan Chevy 619130", cost:264},
        {c:"A011086AU", n:"Armadura VW Jetta 086 Automotive", cost:264},
        {c:"ART75010", n:"Armadura Ford Motorcraft Bolsa", cost:220},
        {c:"PC10530941", n:"Porta Carbon GM Aveo Usatech", cost:75},
        {c:"PC698309", n:"Porta Carbon Mitsubishi Grande", cost:75},
        {c:"PC698308", n:"Porta Carbon Mitsubishi Chico", cost:58},
        {c:"PC36441", n:"Porta Carbon Platina VW Chevy Valeo", cost:69},
        {c:"PC336246", n:"Porta Carbon Ford Nissan 336 246", cost:69},
        {c:"PC336716", n:"Porta Carbon Bosch Automotive", cost:72},
        {c:"PC336200", n:"Porta Carbon VW Jetta Eco", cost:69},
        {c:"PC336245", n:"Porta Carbon Nissan Chevy Tipo Bosch", cost:69},
        {c:"PC698104", n:"Porta Carbon Nissan Colec. Hueco", cost:81},
        {c:"PC698330", n:"Porta Carbon Mitsubishi Urvan 2.5", cost:81},
        {c:"PC69201", n:"Porta Carbon Ford 69201 Value", cost:52},
        {c:"PC698318", n:"Porta Carbon Nissan Urvan 2.4", cost:75},
        {c:"PC69119", n:"Porta Carbon Delco PMGR", cost:75},
        {c:"PC698117", n:"Porta Carbon Nissan Hitachi", cost:64},
        {c:"PC042176", n:"Porta Carbon Ford Automotive", cost:58},
        {c:"SLDSS1750", n:"Automatico Ford Sistema Bosch", cost:220},
        {c:"1219", n:"Automatico Nissan Hitachi Sin Cable", cost:215},
        {c:"11840", n:"Automatico VW Sedan", cost:248},
        {c:"66205", n:"Automatico Ford Motorcraft Guia", cost:204},
        {c:"B55", n:"Modulo Encendido Nissan Tsuru 16V", cost:543},
        {c:"MHZ2030A", n:"Modulo Encendido Nissan", cost:543},
        {c:"BOM-TSURU", n:"Bomba Gasolina Bosch Tsuru III", cost:330},
        {c:"RIH738TP", n:"Regulador Nissan RIH 738 Hitachi", cost:317},
        {c:"RIH744", n:"Regulador Nissan RIH 744 Hitachi", cost:223},
        {c:"RF784TR", n:"Regulador Ford F784 Negro", cost:116},
        {c:"RF794TP", n:"Regulador Ford F794 Gris", cost:135},
        {c:"R3258804", n:"Regulador GM Delco D411 Cutlas", cost:143},
        {c:"RE140X", n:"Regulador GM E-140XR", cost:114},
        {c:"RE141XR", n:"Regulador Ford E-141XR", cost:114},
        {c:"RIB501", n:"Regulador Nissan Tsuru Chueco", cost:145},
        {c:"RD702TP", n:"Regulador GM RD702", cost:126},
        {c:"RLE5001", n:"Regulador Nissan Barco Bosch", cost:248},
        {c:"F9007LED", n:"Foco 9007 LED 4 Caras Juego", cost:253},
        {c:"F9005LED", n:"Foco 9005 LED 4 Caras Baja", cost:220},
        {c:"F9004LED", n:"Foco 9004 LED 4 Caras Juego", cost:275},
        {c:"FH7LED", n:"Foco H7 LED 4 Caras Juego", cost:220},
        {c:"FH11LED", n:"Foco H11 LED 4 Caras Juego", cost:220},
        {c:"FH4LED", n:"Foco H4 LED 4 Caras Juego", cost:253},
        {c:"HX10", n:"Foco 3157 Hella (Caja 10)", cost:116},
        {c:"HXC", n:"Foco 7443 Hella (Caja 10)", cost:157},
        {c:"SH9006", n:"Foco 9006 Hella Baja", cost:47},
        {c:"SH9005", n:"Foco 9005 Hella Alta", cost:49},
        {c:"H13", n:"Foco H13 Hella", cost:156},
        {c:"H4", n:"Foco H4 Hella", cost:31},
        {c:"BM70582", n:"Bulbo Motovent VW Caribe 82/68", cost:98},
        {c:"BM740", n:"Bulbo Motovent GM Chevy", cost:154},
        {c:"BM71795", n:"Bulbo Motovent VW Combi", cost:149},
        {c:"M110881", n:"Marcador Aceite Veethree", cost:176},
        {c:"M37011", n:"Marcador Temperatura VDO", cost:386},
        {c:"CP1830M", n:"Cable Plastico 18 (30m)", cost:121},
        {c:"CP1630", n:"Cable Plastico 16 (30m)", cost:176},
        {c:"CP1430M", n:"Cable Plastico 14 (30m)", cost:270},
        {c:"952011", n:"Bocina Claxon VW Hella", cost:121},
        {c:"01200", n:"Bocina Caracol Seger Doble", cost:174},
        {c:"SPPS100", n:"Switch 75 Amp Arrow", cost:101}
    ];

    let INVENTARIO = JSON.parse(localStorage.getItem('millan_db_v5_1')) || [];
    let MARGEN_ACTUAL = localStorage.getItem('millan_margin') || 30;
    let CARRITO = [];
    let scannerObj = null;

    // AUTO-INICIAR SI EST츼 VAC칈O
    if(INVENTARIO.length === 0) {
        INVENTARIO = JSON.parse(JSON.stringify(DB_MASTER));
        recalcularPreciosInterno();
        guardarDB();
    }
    document.getElementById('global-margin').value = MARGEN_ACTUAL;

    // --- FUNCIONES CORE ---
    function recalcularPreciosInterno() {
        let factor = 1 + (parseFloat(MARGEN_ACTUAL) / 100);
        INVENTARIO.forEach(p => { 
            if(p.cost) p.price = parseFloat((p.cost * factor).toFixed(2)); 
        });
    }

    function guardarDB() {
        localStorage.setItem('millan_db_v5_1', JSON.stringify(INVENTARIO));
        localStorage.setItem('millan_margin', MARGEN_ACTUAL);
        renderCatalog();
    }

    function actualizarPrecios() {
        MARGEN_ACTUAL = parseFloat(document.getElementById('global-margin').value);
        recalcularPreciosInterno();
        guardarDB();
        alert("Precios actualizados al " + MARGEN_ACTUAL + "%");
    }

    function forceReset() {
        if(confirm("쮹ORRAR TODO y cargar lista original?")) {
            localStorage.removeItem('millan_db_v5_1');
            location.reload();
        }
    }

    function renderCatalog() {
        let container = document.getElementById('catalog-container');
        let filter = document.getElementById('catalog-search').value.toUpperCase();
        container.innerHTML = "";

        let results = INVENTARIO.filter(p => p.n.toUpperCase().includes(filter) || p.c.toUpperCase().includes(filter));

        if(results.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>No encontrado.</p>";
            return;
        }

        results.forEach(p => {
            container.innerHTML += `
            <div class="product-card">
                <div class="prod-info">
                    <div class="prod-code">${p.c}</div>
                    <div class="prod-title">${p.n}</div>
                    <div class="prod-price">$${p.price.toFixed(2)}</div>
                    <button class="btn-add" onclick="addCart('${p.c}')">AGREGAR</button>
                </div>
            </div>`;
        });
    }

    function addCart(code) {
        let item = INVENTARIO.find(p => p.c === code);
        CARRITO.push(item);
        // Sonido beep opcional
        // let audio = new Audio('beep.mp3'); audio.play();
        renderCart();
    }

    function renderCart() {
        let div = document.getElementById('cart-list');
        let total = 0;
        div.innerHTML = "";
        
        CARRITO.forEach((p, idx) => {
            total += p.price;
            div.innerHTML += `
            <div class="ticket-item">
                <span>${p.n.substring(0,15)}</span>
                <span>$${p.price.toFixed(2)} <i class="fas fa-times" style="color:red" onclick="remCart(${idx})"></i></span>
            </div>`;
        });
        document.getElementById('total-amount').innerText = total.toFixed(2);
    }

    function remCart(idx) { CARRITO.splice(idx,1); renderCart(); }

    function imprimirTicket() {
        if(CARRITO.length === 0) return alert("Nada");
        let body = document.getElementById('ticket-body');
        document.getElementById('ticket-date').innerText = new Date().toLocaleString();
        body.innerHTML = "";
        CARRITO.forEach(p => {
            body.innerHTML += `<div style="display:flex; justify-content:space-between;"><span>${p.n.substring(0,20)}</span><span>$${p.price.toFixed(2)}</span></div>`;
        });
        document.getElementById('ticket-total').innerText = document.getElementById('total-amount').innerText;
        window.print();
        if(confirm("쯃impiar?")) { CARRITO=[]; renderCart(); }
    }

    // --- ESC츼NER ---
    function toggleScanner() {
        let area = document.getElementById('scanner-area');
        if(area.style.display === 'block') {
            if(scannerObj) scannerObj.clear();
            area.style.display = 'none';
        } else {
            area.style.display = 'block';
            scannerObj = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scannerObj.render(onScanSuccess);
        }
    }

    function onScanSuccess(decodedText) {
        let prod = INVENTARIO.find(p => p.c === decodedText);
        if(prod) {
            addCart(decodedText);
            alert("Detectado: " + prod.n);
            // Pausar para no leer mil veces
            scannerObj.pause();
            setTimeout(() => scannerObj.resume(), 1500);
        } else {
            if(confirm("C칩digo " + decodedText + " no existe. 쮸gregarlo?")) {
                scannerObj.clear();
                document.getElementById('scanner-area').style.display = 'none';
                irA('admin');
                document.getElementById('new-code').value = decodedText;
            }
        }
    }

    function guardarManual() {
        let c = document.getElementById('new-code').value.toUpperCase();
        let n = document.getElementById('new-name').value.toUpperCase();
        let cost = parseFloat(document.getElementById('new-cost').value);
        if(!c || !n || !cost) return alert("Faltan datos");

        let factor = 1 + (parseFloat(MARGEN_ACTUAL) / 100);
        let price = parseFloat((cost * factor).toFixed(2));
        
        INVENTARIO.push({c, n, cost, price});
        guardarDB();
        alert("Guardado");
        document.getElementById('new-code').value = "";
        document.getElementById('new-name').value = "";
        document.getElementById('new-cost').value = "";
    }

    function irA(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
        if(id !== 'pos' && scannerObj) { scannerObj.clear(); document.getElementById('scanner-area').style.display='none'; }
        if(id === 'catalog') renderCatalog();
    }

    renderCatalog();
</script>
</body>
</html>
