<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill√°n - V11 BLINDADA</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ffd700; --dark: #111; --bg: #f0f2f5; --danger: #ff4444; --success: #00c851; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); color: #333; padding-bottom: 100px; user-select: none; }
        
        /* HEADER */
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .logo { font-size: 1.2rem; font-weight: 900; }
        .logo span { color: var(--primary); }
        
        nav button { background: none; border: none; color: #888; font-size: 1.5rem; margin-left: 20px; }
        nav button.active { color: var(--primary); transform: scale(1.2); }

        /* P√ÅGINAS */
        .page { display: none; padding: 15px; }
        .page.active { display: block; }

        /* EL COMPITA (VISIBILIDAD FORZADA) */
        #compita-btn {
            position: fixed; bottom: 20px; right: 20px; width: 70px; height: 70px;
            background: #222; border: 2px solid var(--primary); border-radius: 50%;
            color: var(--primary); font-size: 2rem; z-index: 9999;
            display: flex !important; /* FORZAR VISIBILIDAD */
            align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #compita-btn.listening { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* ESTILOS GENERALES */
        .card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 12px; border: none; border-radius: 5px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); color: white; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* ESCANER */
        #reader { width: 100%; background: black; display: none; margin-bottom: 10px; }

        /* LOGIN */
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000; display:none; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<header>
    <div class="logo">MILL√ÅN <span>V11</span></div>
    <nav>
        <button onclick="irA('home')" id="nav-home" class="active"><i class="fas fa-search"></i></button>
        <button onclick="irA('pos')" id="nav-pos"><i class="fas fa-shopping-cart"></i></button>
        <button onclick="checkAdmin()" id="nav-admin"><i class="fas fa-cog"></i></button>
    </nav>
</header>

<div id="compita-btn" onclick="usarCompita()">
    <i class="fas fa-microphone"></i>
</div>

<div id="home" class="page active">
    <div style="text-align:center; margin: 20px 0;">
        <h2>CAT√ÅLOGO</h2>
        <input type="text" id="search" placeholder="üîç Buscar pieza..." onkeyup="renderCatalog()">
    </div>
    <div id="catalog-list"></div>
</div>

<div id="pos" class="page">
    <h2>CAJA</h2>
    <button class="btn" style="background:#333; color:white;" onclick="toggleCam()">üì∏ C√ÅMARA</button>
    <div id="reader"></div>
    
    <div id="cart-items" style="margin-top:20px; background:white; min-height:100px; padding:10px;"></div>
    <h1 style="text-align:right;">Total: $<span id="total">0</span></h1>
    <button class="btn btn-primary" onclick="cobrar()">COBRAR</button>
</div>

<div id="admin" class="page">
    <h2>ADMINISTRACI√ìN</h2>
    <div style="background:white; padding:15px; border-radius:10px;">
        <label>Ganancia Global (%):</label>
        <input type="number" id="margin" value="30">
        <button class="btn btn-primary" onclick="updatePrices()">APLICAR %</button>
    </div>
    <br>
    <h3>FALTANTES</h3>
    <div id="missing-list" style="background:#fff3cd; padding:10px;"></div>
    <button class="btn btn-danger" onclick="clearMissing()">Borrar Faltantes</button>
    <br><br>
    <button class="btn" style="background:#000; color:fff;" onclick="resetDB()">‚ö†Ô∏è RESET DE F√ÅBRICA</button>
</div>

<div id="login-overlay">
    <h2>PASSWORD</h2>
    <input type="password" id="pin" style="width:150px; font-size:2rem; text-align:center;" placeholder="****">
    <button class="btn btn-primary" style="width:150px;" onclick="validate()">ENTRAR</button>
    <button class="btn" onclick="closeLogin()" style="background:none;">Cancelar</button>
</div>

<script>
    // --- DATOS SEGUROS ---
    const DB_DEFAULT = [
        {c:"E7691809", n:"Engrane Marcha Dodge (2)", cost:30}, {c:"E7691810", n:"Engrane Marcha Ford Bosch (1)", cost:30},
        {c:"EM4", n:"Engrane Marcha Nissan (4)", cost:29}, {c:"PC10530941", n:"Porta Carbon GM Aveo", cost:75},
        {c:"PC336246", n:"Porta Carbon Ford Nissan", cost:69}, {c:"A618114ASS", n:"Armadura Nissan Hitachi", cost:264},
        {c:"B55", n:"Modulo Encendido Tsuru 16V", cost:543}, {c:"BOM-TSURU", n:"Bomba Gasolina Tsuru III", cost:330},
        {c:"F9004LED", n:"Foco 9004 LED 4 Caras", cost:275}, {c:"BM70582", n:"Bulbo Motovent VW Caribe", cost:98}
    ];

    let INVENTARIO = JSON.parse(localStorage.getItem('millan_v11_db')) || [];
    let FALTANTES = JSON.parse(localStorage.getItem('millan_v11_missing')) || [];
    let MARGEN = localStorage.getItem('millan_v11_margin') || 30;
    let CART = [];
    let scanner = null;

    // INICIALIZACI√ìN SEGURA
    try {
        if (INVENTARIO.length === 0) {
            INVENTARIO = JSON.parse(JSON.stringify(DB_DEFAULT));
            recalc();
            save();
        }
        document.getElementById('margin').value = MARGEN;
        renderCatalog();
    } catch (e) {
        alert("Error de carga. Reiniciando...");
        resetDB();
    }

    // --- FUNCIONES CORE ---
    function recalc() {
        let f = 1 + (parseFloat(MARGEN)/100);
        INVENTARIO.forEach(p => { if(p.cost) p.price = Math.ceil(p.cost * f); });
    }
    function save() {
        localStorage.setItem('millan_v11_db', JSON.stringify(INVENTARIO));
        localStorage.setItem('millan_v11_margin', MARGEN);
        localStorage.setItem('millan_v11_missing', JSON.stringify(FALTANTES));
    }
    function updatePrices() {
        MARGEN = document.getElementById('margin').value;
        recalc(); save(); renderCatalog(); alert("Precios Actualizados");
    }
    function resetDB() {
        localStorage.removeItem('millan_v11_db');
        location.reload();
    }

    // --- COMPITA (VOZ) ---
    function usarCompita() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Tu celular no soporta voz. Usa Chrome.");
            return;
        }
        
        let btn = document.getElementById('compita-btn');
        btn.classList.add('listening');
        
        let rec = new webkitSpeechRecognition();
        rec.lang = "es-MX";
        rec.onend = () => btn.classList.remove('listening');
        
        rec.onresult = (e) => {
            let txt = e.results[0][0].transcript.toLowerCase();
            procesar(txt);
        };
        rec.start();
    }

    function procesar(txt) {
        // L√≥gica simple para que no falle
        if(txt.includes("anota") || txt.includes("pide")) {
            FALTANTES.push(txt); save(); renderMissing();
            hablar("Anotado patr√≥n.");
            return;
        }

        let term = txt.replace("busca","").replace("precio","").trim();
        document.getElementById('search').value = term;
        renderCatalog();
        
        let found = INVENTARIO.find(p => p.n.toLowerCase().includes(term));
        if(found) hablar("Sim√≥n, cuesta " + found.price + " pesos.");
        else hablar("No lo topo. ¬øLo anoto?");
    }

    function hablar(msg) {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(msg);
        u.lang = "es-MX";
        window.speechSynthesis.speak(u);
    }

    // --- CATALOGO ---
    function renderCatalog() {
        let q = document.getElementById('search').value.toUpperCase();
        let div = document.getElementById('catalog-list');
        div.innerHTML = "";
        
        let list = INVENTARIO.filter(p => p.n.toUpperCase().includes(q) || p.c.toUpperCase().includes(q));
        
        list.forEach(p => {
            div.innerHTML += `
            <div class="card">
                <div>
                    <div style="font-weight:bold;">${p.n}</div>
                    <div style="color:#666; font-size:0.8rem;">${p.c}</div>
                </div>
                <div style="text-align:right;">
                    <div style="color:green; font-weight:900; font-size:1.2rem;">$${p.price}</div>
                    <button class="btn btn-primary" style="padding:5px; width:auto;" onclick="addCart('${p.c}')">+</button>
                </div>
            </div>`;
        });
    }

    // --- POS ---
    function addCart(c) {
        let p = INVENTARIO.find(x => x.c === c);
        CART.push(p);
        renderCart();
        alert("Agregado");
    }
    function renderCart() {
        let div = document.getElementById('cart-items');
        let tot = 0; div.innerHTML = "";
        CART.forEach((p, i) => {
            tot += p.price;
            div.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;"><span>${p.n}</span><span>$${p.price} <b style="color:red" onclick="delCart(${i})">X</b></span></div>`;
        });
        document.getElementById('total').innerText = tot;
    }
    function delCart(i) { CART.splice(i,1); renderCart(); }
    function cobrar() { if(CART.length>0 && confirm("Cobrar?")) { CART=[]; renderCart(); } }

    // --- ADMIN ---
    function checkAdmin() { document.getElementById('login-overlay').style.display='flex'; }
    function validate() { 
        if(document.getElementById('pin').value === '1234') { 
            closeLogin(); irA('admin'); renderMissing();
        } else alert("Error"); 
    }
    function closeLogin() { document.getElementById('login-overlay').style.display='none'; }
    
    function renderMissing() {
        let d = document.getElementById('missing-list'); d.innerHTML="";
        FALTANTES.forEach(x => d.innerHTML += `<div>‚Ä¢ ${x}</div>`);
    }
    function clearMissing() { FALTANTES=[]; save(); renderMissing(); }

    // --- CAMARA ---
    function toggleCam() {
        let d = document.getElementById('reader');
        if(d.style.display==='block') {
            d.style.display='none'; if(scanner) scanner.clear();
        } else {
            d.style.display='block';
            scanner = new Html5QrcodeScanner("reader", {fps:10, qrbox:250});
            scanner.render((txt)=>{
                let p = INVENTARIO.find(x=>x.c===txt);
                if(p) { addCart(txt); scanner.pause(); setTimeout(()=>scanner.resume(), 1000); }
                else alert("No existe: " + txt);
            });
        }
    }

    // --- NAV ---
    function irA(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
    }
</script>
</body>
</html>
