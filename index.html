<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill치n - V17 VISIBLE</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ffd700; --dark: #111; --bg: #f4f4f4; --success: #00c851; }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: var(--bg); color: #333; padding-bottom: 80px; }
        
        /* HEADER */
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.2rem; font-weight: 900; }
        .logo span { color: var(--primary); }
        nav button { background: none; border: none; color: #888; font-size: 1.5rem; margin-left: 20px; }
        nav button.active { color: var(--primary); transform: scale(1.2); }

        /* P츼GINAS */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* HOME */
        .search-container { position: sticky; top: 60px; z-index: 900; background: var(--bg); padding: 10px 0; }
        .main-input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #ddd; font-size: 1.1rem; outline: none; box-sizing: border-box; }
        
        /* LISTA DE PRODUCTOS (SIEMPRE VISIBLE) */
        .catalog-list { display: flex; flex-direction: column; gap: 10px; }
        .card { background: white; padding: 15px; border-radius: 8px; border-bottom: 3px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .card-info { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 1rem; color: #333; }
        .card-code { font-size: 0.8rem; color: #666; background: #eee; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .card-price { font-size: 1.4rem; font-weight: 900; color: var(--success); text-align: right; min-width: 90px; }
        .btn-add { background: var(--dark); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: pointer; width: 100%; }

        /* CAJA */
        #cart-box { background: white; min-height: 100px; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-top: 20px; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; padding: 15px; font-weight: bold; border: none; border-radius: 8px; margin-top: 10px; font-size: 1.1rem; }

        /* ADMIN */
        input.form-control { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        table { width: 100%; background: white; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #333; color: white; }

        /* EL COMPITA */
        #compita-btn { position: fixed; bottom: 20px; right: 20px; width: 70px; height: 70px; background: #222; border: 2px solid var(--primary); border-radius: 50%; color: var(--primary); font-size: 2rem; z-index: 9999; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #compita-btn.listening { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

<header>
    <div class="logo">MILL츼N <span>V17</span></div>
    <nav>
        <button onclick="irA('home')" id="nav-home" class="active"><i class="fas fa-list"></i></button>
        <button onclick="irA('pos')" id="nav-pos"><i class="fas fa-shopping-cart"></i></button>
        <button onclick="irA('admin')" id="nav-admin"><i class="fas fa-cog"></i></button>
    </nav>
</header>

<div id="compita-btn" onclick="usarCompita()"><i class="fas fa-microphone"></i></div>

<div id="home" class="page active">
    <div class="search-container">
        <input type="text" id="main-search" class="main-input" placeholder="游댌 Buscar pieza..." onkeyup="renderCatalog()">
    </div>
    <button onclick="buscarGoogle()" style="width:100%; padding:10px; background:white; border:1px solid #4285F4; color:#4285F4; border-radius:10px; margin-bottom:15px; font-weight:bold;">
        <i class="fab fa-google"></i> 쯅o est치? Buscar en Google
    </button>
    <div id="catalog-area" class="catalog-list">
        </div>
</div>

<div id="pos" class="page">
    <h2>Caja Registradora</h2>
    <div id="reader" style="width:100%; display:none;"></div>
    <button onclick="toggleCam()" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:5px;">游닞 C츼MARA</button>
    
    <div id="cart-box">
        <div style="text-align:center; color:#aaa;">Carrito vac칤o</div>
    </div>
    <h1 style="text-align:right;">Total: $<span id="total-amount">0</span></h1>
    <button class="btn-primary" onclick="cobrar()">COBRAR</button>
</div>

<div id="admin" class="page">
    <h2>Configuraci칩n</h2>
    <div style="background:white; padding:15px; border-radius:8px; margin-bottom:20px;">
        <label>Ganancia (%):</label> 
        <input type="number" id="margin-input" value="30" style="width:60px;">
        <button onclick="updatePrices()">Actualizar</button>
    </div>

    <h3>Inventario Total</h3>
    <div style="overflow-x:auto;">
        <table id="admin-table">
            <thead><tr><th>C칩d</th><th>Desc</th><th>$$</th><th>X</th></tr></thead>
            <tbody id="admin-body"></tbody>
        </table>
    </div>
    <br>
    <button onclick="resetDB()" style="background:red; color:white; border:none; padding:10px; width:100%;">丘멆잺 RECARGAR DATOS</button>
</div>

<script>
    // --- DATOS REALES (COPIA DE SEGURIDAD) ---
    const DB_REAL = [
        {c:"E7691809", n:"Engrane Marcha Dodge (2)", cost:30}, {c:"E7691810", n:"Engrane Marcha Ford Bosch (1)", cost:30},
        {c:"EM4", n:"Engrane Marcha Nissan (4)", cost:29}, {c:"EM5", n:"Engrane Marcha VW Golf (5)", cost:29},
        {c:"1224", n:"Bendix Zen Ford", cost:114}, {c:"A618114ASS", n:"Armadura Nissan Hitachi", cost:264},
        {c:"A011097E", n:"Armadura Nissan Chevy", cost:264}, {c:"PC10530941", n:"Porta Carbon GM Aveo", cost:75},
        {c:"PC336246", n:"Porta Carbon Ford Nissan", cost:69}, {c:"PC336245", n:"Porta Carbon Nissan Chevy", cost:69},
        {c:"B55", n:"Modulo Encendido Tsuru 16V", cost:543}, {c:"BOM-TSURU", n:"Bomba Gasolina Tsuru III", cost:330},
        {c:"RIH738TP", n:"Regulador Nissan Hitachi", cost:317}, {c:"F9004LED", n:"Foco 9004 LED 4 Caras", cost:275},
        {c:"67HELLA", n:"Foco 67 Hella (Suelto)", cost:3.30}, {c:"158HELLA", n:"Foco 158 Pellizco (Suelto)", cost:2.40},
        {c:"1034HELLA", n:"Foco 1034 (Suelto)", cost:3.50}, {c:"BM70582", n:"Bulbo Motovent VW Caribe", cost:98},
        {c:"CP1830M", n:"Cable Plastico 18 30mts", cost:88}, {c:"952011", n:"Bocina Claxon VW Hella", cost:121}
    ];

    let INVENTARIO = [];
    let MARGEN = 30;
    let CART = [];
    let scanner = null;

    // --- ARRANQUE AUTOM츼TICO ---
    // Usamos una clave nueva "v17" para que no cargue basura vieja
    let stored = localStorage.getItem('millan_v17_db');
    if(stored) {
        INVENTARIO = JSON.parse(stored);
    } else {
        // SI EST츼 VAC칈O, CARGAMOS LOS DATOS REALES AHORA MISMO
        INVENTARIO = JSON.parse(JSON.stringify(DB_REAL));
        // Calculamos precio inicial
        INVENTARIO.forEach(p => p.price = Math.ceil(p.cost * 1.30));
        localStorage.setItem('millan_v17_db', JSON.stringify(INVENTARIO));
    }

    renderCatalog(); // PINTAR LA LISTA INMEDIATAMENTE

    // --- FUNCIONES ---
    function renderCatalog() {
        let q = document.getElementById('main-search').value.toUpperCase();
        let div = document.getElementById('catalog-area');
        div.innerHTML = "";

        // Si el buscador est치 vac칤o, MUESTRA TODO. Si escribes, filtra.
        let list = q ? INVENTARIO.filter(p => p.n.toUpperCase().includes(q) || p.c.includes(q)) : INVENTARIO;

        if(list.length === 0) div.innerHTML = "<p style='text-align:center'>No encontrado.</p>";

        list.forEach(p => {
            div.innerHTML += `
            <div class="card">
                <div class="card-info">
                    <div class="card-title">${p.n}</div>
                    <div class="card-code">${p.c}</div>
                </div>
                <div>
                    <div class="card-price">$${p.price}</div>
                    <button class="btn-add" onclick="addCart('${p.c}')">AGREGAR</button>
                </div>
            </div>`;
        });
    }

    function addCart(c) {
        let p = INVENTARIO.find(x => x.c === c);
        CART.push(p);
        alert("Agregado: " + p.n);
    }

    function renderCart() {
        let div = document.getElementById('cart-box');
        let tot = 0; div.innerHTML = "";
        CART.forEach((p,i) => {
            tot += p.price;
            div.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;"><span>${p.n}</span><span>$${p.price} <b onclick="delCart(${i})" style="color:red">X</b></span></div>`;
        });
        document.getElementById('total-amount').innerText = tot;
        if(CART.length===0) div.innerHTML="Vac칤o";
    }
    function delCart(i) { CART.splice(i,1); renderCart(); }
    
    function cobrar() { if(CART.length>0) { window.print(); CART=[]; renderCart(); } }

    function updatePrices() {
        MARGEN = parseFloat(document.getElementById('margin-input').value);
        let f = 1 + (MARGEN/100);
        INVENTARIO.forEach(p => { if(p.cost) p.price = Math.ceil(p.cost * f); });
        localStorage.setItem('millan_v17_db', JSON.stringify(INVENTARIO));
        renderCatalog(); renderAdmin(); alert("Precios actualizados");
    }

    function renderAdmin() {
        let b = document.getElementById('admin-body'); b.innerHTML="";
        INVENTARIO.forEach(p => {
            b.innerHTML += `<tr><td>${p.c}</td><td>${p.n}</td><td>$${p.cost}</td><td>$${p.price}</td><td><button onclick="delProd('${p.c}')" style="color:red">X</button></td></tr>`;
        });
    }
    function delProd(c) {
        if(confirm("Borrar?")) { INVENTARIO=INVENTARIO.filter(p=>p.c!==c); localStorage.setItem('millan_v17_db', JSON.stringify(INVENTARIO)); renderAdmin(); renderCatalog(); }
    }

    function resetDB() {
        localStorage.removeItem('millan_v17_db'); location.reload();
    }

    function irA(id) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('nav-'+id).classList.add('active');
        if(id==='pos') renderCart();
        if(id==='admin') renderAdmin();
    }

    // VOZ
    function usarCompita() {
        if(!window.webkitSpeechRecognition) return alert("Usa Chrome");
        let btn=document.getElementById('compita-btn'); btn.classList.add('listening');
        let r = new webkitSpeechRecognition(); r.lang="es-MX";
        r.onend = () => btn.classList.remove('listening');
        r.onresult = (e) => {
            let t = e.results[0][0].transcript.toLowerCase().replace("busca","").trim();
            document.getElementById('main-search').value = t;
            renderCatalog();
            let p
