<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill치n - V10 EL COMPITA</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #ffd700; --dark: #111; --light: #eee; --danger: #ff4444; --success: #00cc66; --info: #00d2ff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #eef2f5; color: #333; padding-bottom: 100px; }
        
        /* HEADER */
        header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .logo { font-size: 1.1rem; font-weight: 900; text-transform: uppercase; color: #fff; }
        .logo i { color: var(--primary); font-size: 1.5rem; margin-right: 5px; }
        nav button { background: none; border: none; color: #aaa; font-size: 1.4rem; margin-left: 15px; cursor: pointer; transition: 0.3s; }
        nav button.active { color: var(--primary); transform: scale(1.2); }

        .page { display: none; padding: 15px; max-width: 1000px; margin: 0 auto; }
        .page.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from{opacity:0} to{opacity:1} }

        /* --- EL COMPITA (BOT칍N FLOTANTE) --- */
        #compita-btn {
            position: fixed; bottom: 20px; right: 20px; width: 75px; height: 75px;
            background: linear-gradient(135deg, #222, #444); /* Color m치s rudo */
            border: 2px solid var(--primary);
            border-radius: 50%; color: var(--primary); font-size: 2rem; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); cursor: pointer; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        #compita-btn.listening { background: #ff4444; border-color: white; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* HOME */
        .hero-container { text-align: center; margin-top: 20px; }
        .search-wrapper { margin-bottom: 15px; position: sticky; top: 70px; z-index: 900; }
        .search-input { width: 100%; padding: 15px; border-radius: 30px; border: 1px solid #ccc; font-size: 1.1rem; outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        .product-card { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; display: flex; flex-direction: column; }
        .prod-info { padding: 10px; }
        .prod-title { font-size: 0.85rem; font-weight: bold; min-height: 40px; }
        .prod-price { font-size: 1.2rem; font-weight: 900; color: var(--success); text-align: right; }
        .btn-add { background: var(--dark); color: white; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }

        /* POS & ADMIN */
        .btn-main { background: var(--primary); color: var(--dark); padding: 12px; width: 100%; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .scanner-box { background: black; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: none; }
        #reader { width: 100%; }
        
        /* LOGIN */
        #login-overlay { display: none; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; }
        .pin-input { font-size: 2rem; padding: 10px; width: 150px; text-align: center; letter-spacing: 10px; border: 2px solid var(--primary); border-radius: 10px; }

        /* TICKET */
        .cart-total { font-size: 1.5rem; font-weight: bold; text-align: right; margin: 20px 0; border-top: 2px solid #333; padding-top: 10px; }
        .ticket-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #ccc; background: white; }

        /* LISTA FALTANTES */
        .missing-item { background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 5px; border-left: 4px solid #ffc107; display: flex; justify-content: space-between; }
        
        /* KPIS */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        @media print { body * { visibility: hidden; } #ticket-print-area, #ticket-print-area * { visibility: visible; } #ticket-print-area { position: absolute; left: 0; top: 0; width: 100%; } header, nav, #compita-btn { display: none; } }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="fas fa-bolt"></i> MILL츼N <span>V10</span></div>
    <nav>
        <button onclick="irA('home')" id="nav-home" class="active"><i class="fas fa-search"></i></button>
        <button onclick="irA('pos')" id="nav-pos"><i class="fas fa-shopping-cart"></i></button>
        <button onclick="checkAuth('reports')" id="nav-reports"><i class="fas fa-chart-line"></i></button>
        <button onclick="checkAuth('admin')" id="nav-admin"><i class="fas fa-cog"></i></button>
    </nav>
</header>

<button id="compita-btn" onclick="activarCompita()"><i class="fas fa-headset"></i></button>

<div id="home" class="page active">
    <div class="hero-container">
        <h2 style="margin:0;">REFACCIONARIA <span style="color:var(--primary)">MILL츼N</span></h2>
        <p>P칤cale al Compita para preguntar</p>
    </div>
    <div class="search-wrapper">
        <input type="text" id="local-search" class="search-input" placeholder="游댌 Buscar pieza manual..." onkeyup="buscarLocal()">
    </div>
    <button onclick="buscarGoogle()" style="width:100%; padding:10px; background:white; border:1px solid #4285F4; color:#4285F4; border-radius:20px; font-weight:bold; cursor:pointer; margin-bottom:20px;">
        <i class="fab fa-google"></i> BUSCAR EN GOOGLE
    </button>
    <div id="catalog-grid" class="catalog-grid"></div>
</div>

<div id="pos" class="page">
    <h2><i class="fas fa-cash-register"></i> Caja</h2>
    <button class="btn-main" style="background:#333; color:white; margin-bottom:10px;" onclick="toggleScanner()">游닞 ESCANEAR</button>
    <div id="scanner-area" class="scanner-box"><div id="reader"></div></div>
    <div id="cart-list" style="background:white; min-height:100px; padding:10px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.1);"></div>
    <div class="cart-total">Total: $<span id="total-amount">0.00</span></div>
    <button class="btn-main" style="background:var(--success); color:white;" onclick="cobrar()">COBRAR TICKET</button>
</div>

<div id="reports" class="page">
    <h2><i class="fas fa-chart-pie"></i> Reporte del Patr칩n</h2>
    <div class="kpi-grid">
        <div class="kpi-card"><div>Venta HOY</div><h2 id="sales-today">$0</h2></div>
        <div class="kpi-card" style="color:green;"><div>Utilidad HOY</div><h2 id="profit-today">$0</h2></div>
    </div>
    <div style="background:white; padding:10px; border-radius:10px;">
        <canvas id="salesChart"></canvas>
    </div>
    <h3>Historial Reciente</h3>
    <div id="history-list" style="background:white; padding:10px; max-height:150px; overflow-y:auto; border-radius:10px;"></div>
</div>

<div id="admin" class="page">
    <h2>Configuraci칩n</h2>
    <div style="background:#222; color:white; padding:15px; border-radius:10px;">
        <label>Ganancia Global (%):</label>
        <div style="display:flex; gap:10px;">
            <input type="number" id="global-margin" value="30" style="background:#444; color:white; border:none; width:80px; padding:5px;">
            <button onclick="actualizarPrecios()" style="background:var(--info); border:none; border-radius:5px; font-weight:bold; padding:0 15px;">APLICAR</button>
        </div>
    </div>
    
    <h3>游늶 Lista de Faltantes (Pedidos)</h3>
    <div id="missing-list"></div>
    <button onclick="borrarFaltantes()" style="font-size:0.8rem; color:red; border:none; background:none;">Borrar Lista</button>

    <h3>Agregar Producto</h3>
    <input type="text" id="new-code" placeholder="C칩digo" style="width:100%; padding:10px; margin-bottom:5px;">
    <input type="text" id="new-name" placeholder="Nombre" style="width:100%; padding:10px; margin-bottom:5px;">
    <input type="number" id="new-cost" placeholder="Costo Compra ($)" style="width:100%; padding:10px; margin-bottom:5px;">
    <button class="btn-main" onclick="guardarManual()">GUARDAR</button>
</div>

<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; display:none;">
    <div style="margin-top:30vh; text-align:center;">
        <i class="fas fa-lock" style="font-size:3rem; color:var(--dark);"></i>
        <h3>SOLO PERSONAL</h3>
        <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="****">
        <br><br>
        <button class="btn-main" style="width:150px;" onclick="validarPin()">ENTRAR</button>
        <button onclick="cerrarLogin()" style="background:none; border:none; margin-top:20px; text-decoration:underline;">Cancelar</button>
    </div>
</div>

<div id="ticket-print-area" style="display:none; width:300px; font-family:monospace; padding:10px;">
    <div style="text-align:center;">
        <h3>REFACCIONARIA MILL츼N</h3>
        <div style="text-align:left;" id="ticket-date"></div>
    </div>
    <div id="ticket-body" style="margin-top:10px; font-size:0.9rem;"></div>
    <p>---------------------------</p>
    <div style="text-align:right; font-size:1.2rem; font-weight:bold;">TOTAL: $<span id="ticket-total">0.00</span></div>
</div>

<script>
    // --- DATOS MAESTROS ---
    const DB_MASTER = [
        {c:"E7691809", n:"Engrane Marcha Dodge (2)", cost:30}, {c:"E7691810", n:"Engrane Marcha Ford Bosch (1)", cost:30},
        {c:"EM4", n:"Engrane Marcha Nissan (4) y Chevy", cost:29}, {c:"EM5", n:"Engrane Marcha VW Golf Jetta (5)", cost:29},
        {c:"A618114ASS", n:"Armadura Nissan Hitachi PMGR 114", cost:264}, {c:"A011097E", n:"Armadura Nissan Chevy 619130", cost:264},
        {c:"PC10530941", n:"Porta Carbon GM Aveo Usatech", cost:75}, {c:"PC698309", n:"Porta Carbon Mitsubishi Grande", cost:75},
        {c:"PC336246", n:"Porta Carbon Ford Nissan 336 246", cost:69}, {c:"B55", n:"Modulo Encendido Nissan Tsuru 16V", cost:543},
        {c:"BOM-TSURU", n:"Bomba Gasolina Bosch Tsuru III", cost:330}, {c:"RIH738TP", n:"Regulador Nissan RIH 738 Hitachi", cost:317},
        {c:"CP1830M", n:"Cable Plastico 18 (30m)", cost:121}, {c:"F9004LED", n:"Foco 9004 LED 4 Caras Juego", cost:275}
    ];

    let INVENTARIO = JSON.parse(localStorage.getItem('millan_db_v10')) || [];
    let VENTAS = JSON.parse(localStorage.getItem('millan_sales')) || [];
    let FALTANTES = JSON.parse(localStorage.getItem('millan_missing')) || [];
    let MARGEN_ACTUAL = localStorage.getItem('millan_margin') || 30;
    let CARRITO = [];
    let scannerObj = null;
    let targetPage = "";

    // INICIO
    if(INVENTARIO.length === 0) {
        INVENTARIO = JSON.parse(JSON.stringify(DB_MASTER));
        recalcularPreciosInterno();
        guardarDB();
    }
    document.getElementById('global-margin').value = MARGEN_ACTUAL;

    // --- EL COMPITA: ASISTENTE ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let synth = window.speechSynthesis;
    let isListening = false;
    let lastSearchTerm = "";

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-MX';
        recognition.continuous = false;
        
        recognition.onstart = () => { isListening = true; document.getElementById('compita-btn').classList.add('listening'); };
        recognition.onend = () => { isListening = false; document.getElementById('compita-btn').classList.remove('listening'); };
        recognition.onresult = (event) => { procesarVoz(event.results[0][0].transcript.toLowerCase()); };
    } else {
        document.getElementById('compita-btn').style.display = 'none';
    }

    function activarCompita() {
        if(isListening) recognition.stop();
        else {
            hablar("Qu칠 pas칩 patr칩n, d칤game.");
            recognition.start();
        }
    }

    function hablar(texto) {
        if(synth.speaking) synth.cancel();
        let utter = new SpeechSynthesisUtterance(texto);
        utter.lang = 'es-MX';
        utter.rate = 1.1; // Un poco m치s r치pido
        utter.pitch = 0.9; // Voz un poco m치s grave
        synth.speak(utter);
    }

    function procesarVoz(texto) {
        // CONFIRMAR FALTANTE
        if(lastSearchTerm && (texto.includes("s칤") || texto.includes("sim칩n") || texto.includes("anota"))) {
            FALTANTES.push(lastSearchTerm);
            localStorage.setItem('millan_missing', JSON.stringify(FALTANTES));
            renderFaltantes();
            hablar("Ya est치s, anotado en los pedidos.");
            lastSearchTerm = "";
            return;
        }

        // BUSQUEDA
        let termino = texto.replace("busca", "").replace("tienes", "").replace("hay", "").replace("compita", "").trim();
        document.getElementById('local-search').value = termino;
        buscarLocal();

        let encontrados = INVENTARIO.filter(p => p.n.toLowerCase().includes(termino));
        
        if(encontrados.length > 0) {
            let p = encontrados[0];
            hablar(`Sim칩n carnal, s칤 hay. Tengo ${p.n}. Cuesta ${Math.round(p.price)} varos.`);
            lastSearchTerm = "";
        } else {
            lastSearchTerm = termino;
            hablar(`H칤jole, no lo topo. 쯃o anoto en la lista de faltantes?`);
        }
    }

    // --- FINANZAS ---
    function renderReports() {
        let hoy = new Date().toLocaleDateString();
        let ventasHoy = VENTAS.filter(v => new Date(v.date).toLocaleDateString() === hoy);
        let totalHoy = ventasHoy.reduce((s,v)=>s+v.total,0);
        let utilHoy = totalHoy - ventasHoy.reduce((s,v)=>s+v.costTotal,0);

        document.getElementById('sales-today').innerText = "$"+totalHoy.toFixed(0);
        document.getElementById('profit-today').innerText = "$"+utilHoy.toFixed(0);

        // Grafica
        const ctx = document.getElementById('salesChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        
        let labels=[], data=[];
        for(let i=4;i>=0;i--){
            let d=new Date(); d.setDate(d.getDate()-i);
            labels.push(d.toLocaleDateString().substr(0,5));
            data
